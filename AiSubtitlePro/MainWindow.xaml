<Window x:Class="AiSubtitlePro.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:viewmodels="clr-namespace:AiSubtitlePro.ViewModels"
        xmlns:controls="clr-namespace:AiSubtitlePro.Controls"
        mc:Ignorable="d"
        Title="AI Subtitle Pro" 
        Height="900" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource MaterialDesignPaper}">
    
    <Window.DataContext>
        <viewmodels:MainViewModel />
    </Window.DataContext>

    <Window.InputBindings>
        <!-- 1. Playback -->
        <KeyBinding Key="Space" Command="{Binding PlayPauseCommand}" />
        <KeyBinding Key="P" Modifiers="Ctrl" Command="{Binding PlayPauseCommand}" />
        <KeyBinding Key="Space" Modifiers="Ctrl" Command="{Binding PlayCurrentLineCommand}" />
        
        <!-- 3. Timing -->
        <KeyBinding Key="Q" Command="{Binding SetStartTimeCommand}" />
        <KeyBinding Key="W" Command="{Binding SetEndTimeCommand}" />
        <KeyBinding Key="D" Modifiers="Ctrl" Command="{Binding CommitCommand}" />
        
        <!-- 4. Edit -->
        <KeyBinding Key="Enter" Modifiers="Ctrl" Command="{Binding CommitAndNextCommand}" />
        <KeyBinding Key="Enter" Modifiers="Shift" Command="{Binding CommitAndStayCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Y" Modifiers="Ctrl" Command="{Binding RedoCommand}" />
        
        <!-- 7. Find -->
        <KeyBinding Key="F" Modifiers="Ctrl" Command="{Binding FindCommand}" />
        <KeyBinding Key="H" Modifiers="Ctrl" Command="{Binding ReplaceCommand}" />
        
        <!-- 8. File -->
        <KeyBinding Key="N" Modifiers="Ctrl" Command="{Binding NewDocumentCommand}" />
        <KeyBinding Key="L" Modifiers="Ctrl" Command="{Binding CloseProjectCommand}" />
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenSubtitleCommand}" />
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveCommand}" />
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveAsCommand}" />

        <!-- Subtitle Grid -->
        <KeyBinding Key="A" Modifiers="Ctrl" Command="{Binding SelectAllLinesCommand}" />
    </Window.InputBindings>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Menu -->
            <RowDefinition Height="Auto" />  <!-- Toolbar -->
            <RowDefinition Height="*" />     <!-- Main Content -->
            <RowDefinition Height="Auto" />  <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" Background="{DynamicResource MaterialDesignPaper}">
            <MenuItem Header="_File">
                <MenuItem Header="_New" Command="{Binding NewDocumentCommand}" InputGestureText="Ctrl+N">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="FileDocument" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Open Subtitle..." Command="{Binding OpenSubtitleCommand}" InputGestureText="Ctrl+O">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="FolderOpen" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Open _Media..." Command="{Binding OpenMediaCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Filmstrip" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Cut Video..." Command="{Binding CutVideoCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ContentCut" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="_Close Project" Command="{Binding CloseProjectCommand}" InputGestureText="Ctrl+L" />
                <Separator />
                <MenuItem Header="_Save" Command="{Binding SaveCommand}" InputGestureText="Ctrl+S">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ContentSave" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Save _As..." Command="{Binding SaveAsCommand}" InputGestureText="Ctrl+Shift+S" />
                <Separator />
                <MenuItem Header="Export _Hard-Sub Video..." Command="{Binding ExportHardSubCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="VideoPlus" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Cancel _Export" Command="{Binding CancelExportHardSubCommand}" IsEnabled="{Binding IsExportingHardSub}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Cancel" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="E_xit" Click="Exit_Click" InputGestureText="Alt+F4" />
            </MenuItem>

            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" Command="{Binding UndoCommand}" InputGestureText="Ctrl+Z" IsEnabled="{Binding CanUndo}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Undo" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Redo" Command="{Binding RedoCommand}" InputGestureText="Ctrl+Y" IsEnabled="{Binding CanRedo}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Redo" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="_Add Line" Command="{Binding AddLineCommand}" InputGestureText="Enter">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Plus" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Delete Lines" Command="{Binding DeleteSelectedLinesCommand}" InputGestureText="Delete">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Delete" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="_Split Line" Command="{Binding SplitLineCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="CallSplit" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Merge with Next" Command="{Binding MergeWithNextCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="CallMerge" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <MenuItem Header="_Timing">
                <MenuItem Header="Set _Start Time" Command="{Binding SetStartTimeCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="RayStart" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Set _End Time" Command="{Binding SetEndTimeCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="RayEnd" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="S_hift Timing..." Command="{Binding ShiftTimingCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ClockOutline" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <MenuItem Header="_AI">
                <MenuItem Header="_Transcribe Audio..." Command="{Binding TranscribeAudioCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Microphone" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="T_ranslate Subtitles..." Command="{Binding TranslateSubtitlesCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Translate" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Remove _Bilingual">
                    <MenuItem Header="Keep _1st line" Command="{Binding RemoveBilingualKeepFirstCommand}" />
                    <MenuItem Header="Keep _2nd line" Command="{Binding RemoveBilingualKeepSecondCommand}" />
                </MenuItem>
                <Separator />
                <MenuItem Header="OpenRouter _API Key..." Click="OpenRouterApiKey_Click">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Key" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <MenuItem Header="_View">
                <MenuItem Header="Toggle _Theme" Command="{Binding ToggleThemeCommand}">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="ThemeLightDark" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>

            <MenuItem Header="_Help">
                <MenuItem Header="_About AI Subtitle Pro">
                    <MenuItem.Icon>
                        <materialDesign:PackIcon Kind="Information" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="1" Background="{DynamicResource MaterialDesignPaper}">
            <ToolBar Band="0" BandIndex="0" Background="Transparent">
                <Button ToolTip="New (Ctrl+N)" Command="{Binding NewDocumentCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="FileDocument" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Open (Ctrl+O)" Command="{Binding OpenSubtitleCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="FolderOpen" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Save (Ctrl+S)" Command="{Binding SaveCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="ContentSave" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Export Hard-Sub Video" Command="{Binding ExportHardSubCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="VideoPlus" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Undo (Ctrl+Z)" Command="{Binding UndoCommand}" IsEnabled="{Binding CanUndo}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Undo" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Redo (Ctrl+Y)" Command="{Binding RedoCommand}" IsEnabled="{Binding CanRedo}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Redo" Width="20" Height="20" />
                </Button>
                <Separator />
                <Button ToolTip="Open Media" Command="{Binding OpenMediaCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Filmstrip" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Cut Video" Command="{Binding CutVideoCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="ContentCut" Width="20" Height="20" />
                </Button>
                <Separator />
                <Button ToolTip="Add Line" Command="{Binding AddLineCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Plus" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Delete Line" Command="{Binding DeleteSelectedLinesCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Delete" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Split Line" Command="{Binding SplitLineCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="CallSplit" Width="20" Height="20" />
                </Button>
                <Button ToolTip="Merge Lines" Command="{Binding MergeWithNextCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="CallMerge" Width="20" Height="20" />
                </Button>
                <Separator />
                <Button ToolTip="Transcribe (AI)" Command="{Binding TranscribeAudioCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Microphone" Width="20" Height="20" Foreground="{StaticResource AccentBrush}" />
                </Button>
                <Button ToolTip="Translate (AI)" Command="{Binding TranslateSubtitlesCommand}" Style="{StaticResource ToolButtonStyle}">
                    <materialDesign:PackIcon Kind="Translate" Width="20" Height="20" Foreground="{StaticResource AccentBrush}" />
                </Button>
            </ToolBar>
        </ToolBarTray>

        <!-- Main Content Area -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="2*" MinHeight="200" />   <!-- Video & Waveform -->
                <RowDefinition Height="Auto" />                 <!-- Edit Panel -->
                <RowDefinition Height="*" MinHeight="100" />    <!-- Subtitle Grid -->
            </Grid.RowDefinitions>

            <!-- Top Area: Split Video and Tools -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="3*" MinWidth="400" /> <!-- Video Player -->
                    <ColumnDefinition Width="Auto" />              <!-- Splitter -->
                    <ColumnDefinition Width="2*" MinWidth="300" /> <!-- Right Panel (Waveform + Edit) -->
                </Grid.ColumnDefinitions>

                <!-- Left: Video Player -->
                <controls:VideoPlayerControl x:Name="VideoPlayer" Grid.Column="0" Margin="4"
                                             Source="{Binding MediaFilePath}"
                                             CurrentSubtitle="{Binding ActiveSubtitleAss}"
                                             TrimStart="{Binding CutStartAbs}"
                                             TrimEnd="{Binding CutEndAbs}"
                                             PositionChanged="VideoPlayer_PositionChanged" />

                <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" Background="Transparent" />

                <!-- Right: Waveform and Edit Panel -->
                <Grid Grid.Column="2" Margin="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="150" MinHeight="100"/> <!-- Waveform -->
                        <RowDefinition Height="Auto" />               <!-- Splitter -->
                        <RowDefinition Height="*" />                  <!-- Edit Panel -->
                    </Grid.RowDefinitions>

                    <!-- Waveform -->
                    <Border Grid.Row="0" BorderBrush="#3F3F46" BorderThickness="1" CornerRadius="4" Background="{StaticResource SurfaceBrush}">
                         <controls:WaveformControl x:Name="WaveformControl"
                                                  AudioPath="{Binding WaveformAudioPath}"
                                                  Position="{Binding CurrentPosition}"
                                                  Duration="{Binding MediaDuration}"
                                                  Subtitles="{Binding DisplayedLines}" />
                    </Border>
                    
                    <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch" Background="Transparent" />

                    <!-- Edit Panel (Moved here) -->
                    <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}" CornerRadius="4" Padding="8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" /> <!-- Controls -->
                                <RowDefinition Height="*" />    <!-- Text Box -->
                            </Grid.RowDefinitions>

                            <!-- Tool Bar / Controls -->
                            <StackPanel Grid.Row="0" Margin="0,0,0,8">
                                <!-- Styles & Actions -->
                                <DockPanel Margin="0,0,0,8">
                                    <ComboBox DockPanel.Dock="Left" Width="140" Margin="0,0,8,0"
                                              ItemsSource="{Binding CurrentDocument.Styles}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Name"
                                              SelectedValue="{Binding SelectedLine.StyleName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="True"
                                              ToolTip="Style Name"
                                              Background="White" Foreground="#111111" />
                                    <CheckBox DockPanel.Dock="Left" Content="Override" Margin="0,0,8,0"
                                              IsChecked="{Binding SelectedLine.UseStyleOverride, Mode=TwoWay}" />
                                    <Button DockPanel.Dock="Left" ToolTip="Add Style" Command="{Binding AddStyleCommand}"
                                            Width="28" Height="28" Margin="0,0,4,0" Style="{StaticResource ToolButtonStyle}">
                                        <materialDesign:PackIcon Kind="Plus" Width="18" Height="18" />
                                    </Button>
                                    <Button DockPanel.Dock="Left" ToolTip="Rename Style" Command="{Binding RenameStyleCommand}"
                                            Width="28" Height="28" Margin="0,0,4,0" Style="{StaticResource ToolButtonStyle}">
                                        <materialDesign:PackIcon Kind="Pencil" Width="18" Height="18" />
                                    </Button>
                                    <Button DockPanel.Dock="Left" ToolTip="Delete Style" Command="{Binding DeleteStyleCommand}"
                                            Width="28" Height="28" Margin="0,0,8,0" Style="{StaticResource ToolButtonStyle}">
                                        <materialDesign:PackIcon Kind="Delete" Width="18" Height="18" />
                                    </Button>
                                    <Button DockPanel.Dock="Left" Content="Apply All" Command="{Binding ApplyStyleToAllCommand}" 
                                            Height="28" Padding="8,0" Margin="0,0,8,0" Style="{StaticResource ToolButtonStyle}" Background="#333"/>
                                    
                                    <!-- Timing display -->
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                         <TextBlock Text="CPS:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                         <TextBlock Text="{Binding SelectedLine.Cps, StringFormat='F1'}" Foreground="White" VerticalAlignment="Center" Width="30"/>
                                    </StackPanel>
                                </DockPanel>

                                <!-- Time Edits -->
                                <WrapPanel>
                                    <TextBlock Text="Start" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBox Width="72" Height="26" Text="{Binding SelectedLine.Start, Mode=TwoWay, StringFormat='h\:mm\:ss\.ff'}" 
                                             Margin="0,0,10,0" ToolTip="Start Time"
                                             Background="White" Foreground="#111111" CaretBrush="#111111"
                                             BorderBrush="#C9C9C9" BorderThickness="1" Padding="6,0"/>
                                    <TextBlock Text="End" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBox Width="72" Height="26" Text="{Binding SelectedLine.End, Mode=TwoWay, StringFormat='h\:mm\:ss\.ff'}" 
                                             Margin="0,0,10,0" ToolTip="End Time"
                                             Background="White" Foreground="#111111" CaretBrush="#111111"
                                             BorderBrush="#C9C9C9" BorderThickness="1" Padding="6,0"/>
                                    <TextBlock Text="Dur" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding SelectedLine.Duration, StringFormat='s\.ff'}" VerticalAlignment="Center" Foreground="Gray"/>
                                </WrapPanel>

                                <!-- Style Edits -->
                                <WrapPanel Margin="0,8,0,0">
                                    <TextBlock Text="Font" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <ComboBox Width="150" Height="26" Margin="0,0,8,0"
                                              ItemsSource="{Binding InstalledFontFamilies}"
                                              SelectedItem="{Binding SelectedStyleFontName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="True"
                                              ToolTip="Font Family"
                                              Background="White" Foreground="#111111" />
                                    <TextBlock Text="Size" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBox Width="48" Height="26"
                                             Text="{Binding SelectedStyleFontSize, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True, ValidatesOnDataErrors=True}"
                                             Margin="0,0,12,0" ToolTip="Font Size"
                                             Background="White" Foreground="#111111" CaretBrush="#111111"
                                             BorderBrush="#C9C9C9" BorderThickness="1" Padding="6,0"
                                             PreviewTextInput="NumericTextBox_PreviewTextInput"
                                             DataObject.Pasting="NumericTextBox_Pasting" />

                                    <TextBlock Text="Text" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <Button Width="22" Height="22" Margin="0,0,12,0" Click="PickPrimaryColor_Click"
                                            Background="{Binding SelectedStylePrimaryAssColor, Converter={StaticResource AssColorToBrushConverter}}"
                                            BorderBrush="#999" BorderThickness="1" />

                                    <TextBlock Text="Outline" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBox Width="44" Height="26"
                                             Text="{Binding SelectedStyleOutline, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True, ValidatesOnDataErrors=True}"
                                             Margin="0,0,6,0" ToolTip="Outline"
                                             Background="White" Foreground="#111111" CaretBrush="#111111"
                                             BorderBrush="#C9C9C9" BorderThickness="1" Padding="6,0"
                                             PreviewTextInput="NumericTextBox_PreviewTextInput"
                                             DataObject.Pasting="NumericTextBox_Pasting" />
                                    <Button Width="22" Height="22" Margin="0,0,12,0" Click="PickOutlineColor_Click"
                                            Background="{Binding SelectedStyleOutlineAssColor, Converter={StaticResource AssColorToBrushConverter}}"
                                            BorderBrush="#999" BorderThickness="1" />

                                    <TextBlock Text="Box" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <Button Width="22" Height="22" Margin="0,0,6,0" Click="PickBackColor_Click"
                                            Background="{Binding SelectedStyleBackAssColor, Converter={StaticResource AssColorToBrushConverter}}"
                                            BorderBrush="#999" BorderThickness="1" />
                                    <CheckBox Content="On" IsChecked="{Binding SelectedStyleBoxEnabled, Mode=TwoWay}" VerticalAlignment="Center"/>
                                </WrapPanel>

                                <!-- Position -->
                                <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                    <TextBlock Text="Pos:" Foreground="Gray" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding SelectedLine.PosX}" Foreground="White" VerticalAlignment="Center"/>
                                    <TextBlock Text="," Foreground="White" VerticalAlignment="Center" Margin="2,0"/>
                                    <TextBlock Text="{Binding SelectedLine.PosY}" Foreground="White" VerticalAlignment="Center"/>
                                    <TextBlock Text="(click on video to set)" Foreground="Gray" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- Large Edit Box -->
                            <TextBox Grid.Row="1"
                                     x:Name="SubtitleEditBox"
                                     Text="{Binding SelectedLine.Text, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     VerticalScrollBarVisibility="Auto"
                                     PreviewKeyDown="SubtitleEditBox_PreviewKeyDown"
                                     FontSize="16"
                                     FontFamily="Segoe UI"
                                     Background="White"
                                     Foreground="#111111"
                                     CaretBrush="#111111"
                                     Padding="8" 
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- Bottom Row: Subtitle Grid -->
            <Border Grid.Row="2" Background="{StaticResource SurfaceBrush}" Margin="4" CornerRadius="4">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Grid Header -->
                    <Border Grid.Row="0" Background="{StaticResource SurfaceLightBrush}" CornerRadius="4,4,0,0" Padding="8,4">
                        <Grid>
                            <TextBlock Text="Subtitles" FontWeight="SemiBold" VerticalAlignment="Center" />
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <TextBlock Text="{Binding DisplayedLines.Count, StringFormat='{}{0} lines'}" 
                                          Foreground="Gray" VerticalAlignment="Center" Margin="0,0,8,0" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Subtitle DataGrid -->
                    <DataGrid x:Name="SubtitleGrid" Grid.Row="1"
                             ItemsSource="{Binding DisplayedLines}"
                             SelectedItem="{Binding SelectedLine, Mode=TwoWay}"
                             IsSynchronizedWithCurrentItem="True"
                             Style="{StaticResource SubtitleGridStyle}"
                             RowStyle="{StaticResource SubtitleGridRowStyle}"
                             CellStyle="{StaticResource SubtitleGridCellStyle}"
                             SelectionMode="Extended"
                             SelectionUnit="FullRow"
                             PreviewKeyDown="SubtitleGrid_PreviewKeyDown"
                             SelectionChanged="SubtitleGrid_SelectionChanged">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="40" IsReadOnly="True" />
                            <DataGridTextColumn Header="Start" Binding="{Binding Start, StringFormat='{}{0:h\\:mm\\:ss\\.ff}'}" Width="90" IsReadOnly="True" />
                            <DataGridTextColumn Header="End" Binding="{Binding End, StringFormat='{}{0:h\\:mm\\:ss\\.ff}'}" Width="90" IsReadOnly="True" />
                            <DataGridTextColumn Header="Text" Binding="{Binding Text}" Width="*" IsReadOnly="True" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>


        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Style="{StaticResource StatusBarStyle}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem>
                <StackPanel Orientation="Horizontal"
                            Visibility="{Binding IsFfmpegBusy, Converter={StaticResource BoolToVisibilityConverter}}">
                    <ProgressBar Width="140" Height="12" Minimum="0" Maximum="100" Value="{Binding FfmpegProgressPercent}" />
                    <TextBlock Text="{Binding FfmpegProgressPercent, StringFormat=' {0}%'}" Margin="8,0,0,0" />
                    <Button Content="Cancel" Command="{Binding CancelExportHardSubCommand}"
                            IsEnabled="{Binding IsExportingHardSub}"
                            Margin="12,0,0,0" Height="22" Padding="10,0" Style="{StaticResource ToolButtonStyle}" />
                </StackPanel>
            </StatusBarItem>
            <Separator />
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding CurrentDocument.FileName}" Margin="0,0,16,0" />
                    <TextBlock>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentDocument.IsDirty}" Value="True">
                                        <Setter Property="Text" Value="● Modified" />
                                        <Setter Property="Foreground" Value="Orange" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
